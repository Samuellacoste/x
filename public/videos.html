<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="apple-touch-icon" href="/favicon.ico" />
    <link rel="image/vnd.microsoft.icon" rel="icon" href="/favicon.ico" />
    <link rel="me" href="http://nparashuram.com" />
    <link rel="canonical" href="http://nparashuram.com" />
    <meta name="theme-color" content="#fff" />
    <link href="main.css" rel="stylesheet" />
    <style>
      .videos h3.camera-name {
        margin-bottom: 0;
        padding: 15px 10px;
        background-color: #abcdef;
        display: inline-block;
      }

      .videos .camera-container {
        margin: 0 0 10px 0;
        flex-wrap: wrap;
        background-color: #abcdef;
        display: flex;
        justify-content: flex-start;
        padding: 6px;
      }

      .videos div.videoItem {
        padding: 0;
        margin: 3px 3px;
        list-style: none;
        border: SOLID 1px #222;
        background-color: #eee;
        border-radius: 4px;
        cursor: pointer;
      }
      .videos .videoItem a:hover {
        background-color: #333;
        color: #ccc;
      }

      .videos .videoItem a {
        font-family: "Courier New", Courier, monospace;
        font-size: 1.2em;
        font-weight: 800;
        text-decoration: none;
        display: block;
        padding: 10px;
      }
      .videos .separator {
        display: block;
        width: 100%;
        height: 20px;
      }

      .videos .delete-cam-date {
        display: inline-block;
        font-size: 1.5em;
        border: SOLID 2px lightcoral;
        padding: 8px;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
    <title>OC835 - Cameras</title>
  </head>
  <body>
    <div id="root" class="root videos">
      <div class="lds-ripple">
        <div></div>
        <div></div>
      </div>
    </div>
    <script type="text/javascript">
      const pad2 = (num) => ("0" + num).slice(-2);
      const getFormattedTime = (d) =>
        `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;

      const deleteVideos = (videos) => {
        if (
          confirm(`Are you sure you want to delete ${videos.length} videos ? `)
        ) {
          console.log(`Deleting ${videos.length} videos `, videos);
          fetch("/api/videos/delete", {
            method: "POST",
            body: JSON.stringify(videos),
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((res) => res.json())
            .then((data) => {
              console.log(data);
              alert(
                `Deleted ${data.fulfilled.length} videos. ` +
                  (data.rejected.length
                    ? `Could not delete ${data.rejected.length} videos`
                    : "")
              );
              window.location.reload();
            })
            .catch((e) => {
              console.log("Error deleting videos ", e);
            });
        }
      };

      (async function (window) {
        const response = await fetch("/api/videos", {
          headers: {
            pragma: "no-cache",
            "cache-control": "no-cache",
          },
        });
        const videos = (await response.json()).reduce(
          (acc = {}, { camera, time, file }) => {
            if (camera && time && file) {
              const date = new Date(time);
              if (acc[date.toDateString()] == null) {
                acc[date.toDateString()] = {};
              }
              if (acc[date.toDateString()][camera] == null) {
                acc[date.toDateString()][camera] = {};
              }
              if (acc[date.toDateString()][camera][date.getHours()] == null) {
                acc[date.toDateString()][camera][date.getHours()] = [];
              }
              acc[date.toDateString()][camera][date.getHours()].push({
                time: new Date(time),
                file,
              });
            }
            return acc;
          },
          {}
        );
        console.log(videos);

        const html =
          Object.keys({}).length === 0 ? ["<h1>No Videos recorded</h1>"] : [];
        for (const date in videos) {
          html.push(`<h2>${date}</h2>`);
          for (const cam in videos[date]) {
            html.push(
              `<div ><h3 class='camera-name'>${cam} (${date})</h3> <div class='delete-cam-date' onclick='deleteVideos(${JSON.stringify(
                Object.keys(videos[date][cam]).reduce(
                  (acc, cur) => [
                    ...acc,
                    ...videos[date][cam][cur].map(({ file }) => file),
                  ],
                  []
                )
              )})'>üóëÔ∏è</div></div>`
            );
            html.push('<div class="camera-container">');
            for (const hour in videos[date][cam]) {
              html.push(
                videos[date][cam][hour]
                  .map(
                    ({ time, file }) =>
                      `<div class="videoItem"><a href = '/raw/videos/${file}'>${getFormattedTime(
                        time
                      )}</a></div>`
                  )
                  .join("")
              );
              html.push("<div class='separator'></div>");
            }
            html.push("</div>");
          }
          html.push("<hr/>");
        }

        document.getElementById("root").innerHTML = html.join("");
      })(window);
    </script>
  </body>
</html>

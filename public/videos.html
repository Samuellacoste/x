<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="MSSmartTagsPreventParsing" content="true" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="apple-touch-icon" href="/favicon.ico" />
    <link rel="image/vnd.microsoft.icon" rel="icon" href="/favicon.ico" />
    <link rel="me" href="http://nparashuram.com" />
    <link rel="canonical" href="http://nparashuram.com" />
    <meta name="theme-color" content="#fff" />
    <link href="main.css" rel="stylesheet" />
    <style>
      .videos h3.camera-name {
        margin-bottom: 0;
        padding: 15px 10px;
        background-color: #abcdef;
        display: inline-block;
      }

      .videos .camera-video-container {
        margin: 0 0 10px 0;
        flex-wrap: wrap;
        flex-direction: column;
        background-color: #abcdef;
        display: flex;
        justify-content: flex-start;
        padding: 6px;
      }

      .videos .hour-container {
        margin: 10px 0;
        flex-wrap: wrap;
        flex-direction: row;
      }

      .videos div.video-item {
        padding: 0;
        margin: 3px 3px;
        list-style: none;
        border: SOLID 1px #222;
        background-color: #eee;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block;
      }

      .videos .videoItem a:hover {
        background-color: #333;
        color: #ccc;
      }

      .videos .video-item a {
        font-family: "Courier New", Courier, monospace;
        font-size: 1.2em;
        font-weight: 800;
        text-decoration: none;
        display: block;
        padding: 10px;
      }

      .videos .delete-cam-date {
        display: inline-block;
        font-size: 1em;
        border: SOLID 2px lightcoral;
        padding: 4px 3px 4px 7px;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
    <title>OC835 - Cameras</title>
  </head>
  <body>
    <div id="videoContainer" class="root videos">
      <div class="lds-ripple">
        <div></div>
        <div></div>
      </div>
    </div>
    <script type="text/javascript">
      function getFormattedTime(d) {
        const pad2 = (num) => ("0" + num).slice(-2);
        return `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(
          d.getSeconds()
        )}`;
      }

      function deleteVideos(videos) {
        if (
          confirm(`Are you sure you want to delete ${videos.length} videos ? `)
        ) {
          console.log(`Deleting ${videos.length} videos `, videos);
          fetch("/api/videos/delete", {
            method: "POST",
            body: JSON.stringify(videos),
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((res) => res.json())
            .then((data) => {
              console.log(data);
              alert(
                `Deleted ${data.fulfilled.length} videos. ` +
                  (data.rejected.length
                    ? `Could not delete ${data.rejected.length} videos`
                    : "")
              );
              window.location.reload();
            })
            .catch((e) => {
              console.log("Error deleting videos ", e);
            });
        }
      }

      const fetchVideos = () =>
        fetch("/api/videos", {
          headers: { pragma: "no-cache", "cache-control": "no-cache" },
        })
          .then((response) => response.json())
          .then((videos) =>
            videos.reduce((acc, { camera: cam, time: timeStr, file }, idx) => {
              if (cam && timeStr && file) {
                const time = new Date(timeStr),
                  day = time.toDateString(),
                  hr = time.getHours();

                acc[day] == null && (acc[day] = {});
                acc[day][cam] == null && (acc[day][cam] = {});
                acc[day][cam][hr] == null && (acc[day][cam][hr] = []);

                acc[day][cam][hr].push({ time, file });
              }
              return acc;
            }, {})
          );

      const renderHours = (hours) => `
        <div class = "hour-container">
          ${hours
            .map(
              ({ file, time }) => `
              <div class="video-item">
                <a href="/raw/videos/${file}" title="${file}">
                  ${getFormattedTime(time)}
                </a>
              </div>`
            )
            .join("")}
        </div>`;

      const renderCamForDate = ([camera, hours]) => `
        <div>
          <h3 class='camera-name'>${camera}</h3>
          <div class='delete-cam-date' 
            onclick='deleteVideos(${JSON.stringify(
              Object.values(hours).reduce(
                (acc, cur) => [...acc, ...cur.map(({ file }) => file)],
                []
              )
            )})
          '>
            üóëÔ∏è
          </div>
          <div class='camera-video-container'>
          ${Object.values(hours).map(renderHours).join("")}
        </div>
      `;

      const renderDate = ([date, cameras]) => `
        <div>
            <h2>${date}</h2>
            ${Object.entries(cameras).map(renderCamForDate).join("")}
        </div>
      `;

      document.addEventListener("DOMContentLoaded", async () => {
        const videos = await fetchVideos();
        console.log(videos);
        document.getElementById("videoContainer").innerHTML =
          Object.keys(videos).length === 0
            ? "<h1>No Videos recorded</h1>"
            : Object.entries(videos).map(renderDate).join("");
      });
    </script>
  </body>
</html>
